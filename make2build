#!/bin/bash
# @author CHEN Feng <phongchen@tencent.com>
# convert Makefile to BUILD
# $ make2build > BUILD to convert Makefile to BUILD file
# the 'deps' part is empty, you should fill it manually

if o=`make dumptargets $@`; then
    o=`echo "$o" | \
    sed -r \
        -e 's/_32d?\.a\b//g' -e 's/_32d?\.so\b//g' \
        -e 's/_64d?\.a\b//g' -e 's/_64d?\.so\b//g' \
        -e 's/32d?\.a\b//g' -e 's/32d?\.so\b//g' \
        -e 's/64d?\.a\b//g' -e 's/64d?\.so\b//g' \
        -e 's/_64d\b//g' -e 's/_32d?\b//g' \
        -e 's/64d?\b//g' -e 's/32d?\b//g' \
        -e 's/\.a\b//g' -e 's/\.so\b//g' | \
    sort -u`

    echo -e "# BUILD script, generated by make2build\n"

    echo "$o" | \
    while read target assign sources; do
        targetname=${target/.sources/}
        case $targetname in
            lib*)
                echo -e "cc_library(\n    name = '${targetname/lib/}',"
                ;;
            *_test|*-test)
                echo -e "cc_test(\n    name = '${targetname}',"
                ;;
            *)
                echo -e "cc_binary(\n    name = '$targetname',"
                ;;
        esac

        echo -ne "    srcs = ["
        output=0
        for source in $sources; do
            if ! [[ $source =~ "\.pb\.cc$" ]]; then
                if [ $output -eq 0 ]; then
                    echo -ne "\n        '$source'"
                    output=1
                else
                    echo -ne ",\n        '$source'"
                fi
            fi
        done
        [ $output -ne 0 ] && echo -en "\n    "
        echo -e "],\n    deps = [\n    ]"

        echo -e ")\n"
    done
fi

