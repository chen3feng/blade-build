#!/bin/bash
# generate BUILD file for library dir
# @author CHEN Feng <phongchen@tencent.com>

shopt -s nullglob

libname=$(basename $(pwd))

echo -e "# generated by $(basename $0)\n"

# generate proto_library
for src in *.proto; do
    echo -e "proto_library(\n    name = '${src/./_}',\n    srcs = '$src'\n)\n"
done

# generate cc_library
test_src_pattern='_test\.c.*$'
test_src_pattern2='Test\.c.*$'
echo -e "cc_library(\n    name = '$libname',\n    srcs = ["
for src in *.{c,cc,cpp,cxx}; do
    if ! [[ ($src =~ $test_src_pattern) || ($src =~ $test_src_pattern2) ]]; then
        echo "        '$src',"
    fi
done
echo -e "    ]\n)\n"

# generate cc_test
for src in *_test.{c,cc,cpp,cxx} *Test.{c,cc,cpp,cxx}; do
    echo -e "\ncc_test(\n    name = '${src/.*/}',\n    srcs = ['$src'],\n    deps = [':$libname']\n)\n"
done

